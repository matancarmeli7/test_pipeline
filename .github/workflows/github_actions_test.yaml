on:
  push:
    branches:
    - main
jobs:
  CI-csi:
    name: "matan test CI"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v2
      - name: Set up Python
        uses: actions/setup-python@v2
        with:
          python-version: '3.x'
      - name: Install dependencies
        run: python -m pip install --upgrade pip yq
      - name: create kind cluster 2
        run: |
          pwd
          ls -l
          ansible-pull -U https://github.com/operator-framework/operator-test-playbooks -C master -i localhost, -e ansible_connection=local -e run_upstream=true -e run_remove_catalog_repo=false upstream/local.yml -e run_prepare_catalog_repo_upstream=false --tags reset
          docker run -d -i -e ANSIBLE_CONFIG=/playbooks/upstream/ansible.cfg -e GODEBUG=x509ignoreCN=0 --name op-test --privileged --net host -v ~/.optest/certs:/usr/share/pki/ca-trust-source/anchors -e STORAGE_DRIVER=vfs -e BUILDAH_FORMAT=docker -v ~/test_pipeline:/tmp/community-operators-for-catalog quay.io/operator_testing/operator-test-playbooks:latest
          docker cp ~/.kube/ op-test:/root/
          docker exec -i -e ANSIBLE_CONFIG=/playbooks/upstream/ansible.cfg -e GODEBUG=x509ignoreCN=0 op-test /bin/bash -c 'update-ca-trust && ansible-playbook -i localhost, -e ansible_connection=local upstream/local.yml -e run_upstream=true -e image_protocol='\''docker://'\'' -vv -e container_tool=podman -e run_prepare_catalog_repo_upstream=false -e operator_dir=/tmp/community-operators-for-catalog/upstream-community-operators/ibm-block-csi-operator-community -e operator_version=1.5.0 --tags pure_test -e operator_channel_force=optest -e strict_mode=true -e opm_index_add_mode=replaces'
#          which jq
#          export yq_path=`which yq`
#          ansible-pull -U https://github.com/operator-framework/operator-test-playbooks -C master -i localhost, -e ansible_connection=local -e run_upstream=true -e run_remove_catalog_repo=false upstream/local.yml -e run_prepare_catalog_repo_upstream=false --tags reset
#          ansible-pull -U https://github.com/operator-framework/operator-test-playbooks -C master -i localhost, -e ansible_connection=local upstream/local.yml -e run_upstream=true -e image_protocol='docker://' -e container_tool=podman -e run_prepare_catalog_repo_upstream=false -e operator_dir=$PWD/upstream-community-operators/ibm-block-csi-operator-community -e operator_version=1.5.0 --tags pure_test -e operator_channel_force=optest -e strict_mode=true -e yq_bin_path=$yq_path
      #- name: kiwi / Full operator test
      #  env:
      #    OP_TEST_SCRIPT_URL: "https://raw.githubusercontent.com/operator-framework/operator-test-playbooks/master/upstream/test/test.sh"
      #  run: |
      #    bash <(curl -sL $OP_TEST_SCRIPT_URL) kiwi "upstream-community-operators/ibm-block-csi-operator-community/1.5.0"
      #- name: check cluster
      #  run: |
      #    kubectl apply -f https://raw.githubusercontent.com/IBM/ibm-block-csi-operator/master/deploy/installer/generated/ibm-block-csi-operator.yaml
      #    kubectl apply -f https://raw.githubusercontent.com/IBM/ibm-block-csi-operator/master/deploy/crds/csi.ibm.com_v1_ibmblockcsi_cr.yaml
      #    kubectl get pods -A
      - name: check cluster
        run: |
          kubectl get pods -A
